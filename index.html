<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edit Invoice</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/fontawesome.min.css"
      integrity="sha384-NvKbDTEnL+A8F/AA5Tc5kmMLSJHUO868P+lDtTpJIeQdGYaUIuLr4lVGOEA1OcMy"
      crossorigin="anonymous"
    />
    <style>
      .highlight-label {
        padding: 0.5rem;
        border-radius: 4px;
        font-weight: bold;
      }
      .custom-height {
        height: 46px; /* Adjust the height as needed */
        padding: 10px; /* Adjust padding if needed */
        font-size: 1rem; /* Adjust font size if needed */
      }
    </style>
  </head>
  <body>
    <div class="container mt-5" style="width: 90%">
      <div class="card shadow-sm p-4">
        <h3 class="card-title mb-4">Edit Invoice</h3>
        <form id="invoice-form">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="invoice-type" class="form-label highlight-label"
                >Invoice Type</label
              >
              <select id="inv_type_ID" name="invoice_type" class="form-select custom-height">
                <option value="">Select--</option>
                <option value="NI">NI</option>
                <option value="EXP">EXP</option>
                <option value="GeeSons">GeeSons</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="client" class="form-label highlight-label"
                >Client</label
              >
              <select id="client" name="client" class="form-select custom-height">
                <option value=" ">Select--</option>
                <option value="Abel Joseph">Abel Joseph</option>
                <option value="Adworth">Adworth</option>
                <option value="Anbalagan Pachaiyappan">
                  Anbalagan Pachaiyappan
                </option>
                <option value="Bulls Eye Knowledge System Pvt Ltd">
                  Bulls Eye Knowledge System Pvt Ltd
                </option>
                <option value="Careerprabhu Education Pvt Ltd.">
                  Careerprabhu Education Pvt Ltd.
                </option>
                <option value="Chris Mcmohon">Chris Mcmohon</option>
                <option value="DCIT (HQ) (Admn), Chandigarh">
                  DCIT (HQ) (Admn), Chandigarh
                </option>
                <option value="Georgia Marantos">Georgia Marantos</option>
                <option value="Georgia Marantos">Georgia Marantos</option>
                <option value="Gerry Singh">Gerry Singh</option>
                <option value="Hammed naeem">Hammed naeem</option>
                <option value="Harish">Harish</option>
                <option value="Harsh">Harsh</option>
                <option value="Hiteish">Hiteish</option>
                <option value="Infinite">Infinite</option>
                <option value="Infinite Computer Solutions Inc.">
                  Infinite Computer Solutions Inc.
                </option>
                <option value="Jyoti">Jyoti</option>
                <option value="Kazumi Ohata">Kazumi Ohata</option>
                <option value="Kellton Tech Solutions Ltd">
                  Kellton Tech Solutions Ltd
                </option>
                <option value="Kiara Williams">Kiara Williams</option>
                <option value="Lukas">Lukas</option>
                <option value="Marlin Gremli">Marlin Gremli</option>
                <option value="Matthew">Matthew</option>
                <option value="Mayak agarwal">Mayak agarwal</option>
                <option value="Mr. Abhishek Singh">Mr. Abhishek Singh</option>
                <option value="Mr. Bhupinder Grewal">
                  Mr. Bhupinder Grewal
                </option>
                <option value="Mr. HOMA">Mr. HOMA</option>
                <option value="Mr. Nippun">Mr. Nippun</option>
                <option value="Mr. Pawan">Mr. Pawan</option>
                <option value="Mr. Shiv Kumar Garg">Mr. Shiv Kumar Garg</option>
                <option value="Mr. Varun Gupta">Mr. Varun Gupta</option>
                <option value="Pavan Kumar">Pavan Kumar</option>
                <option value="Puneet Verma">Puneet Verma</option>
                <option value="Rohit Bansal">Rohit Bansal</option>
                <option value="Safdar Sahito">Safdar Sahito</option>
                <option value="Shari Johns">Shari Johns</option>
                <option value="Shari Johns">Shari Johns</option>
                <option value="Shekhar Malhota">Shekhar Malhota</option>
                <option value="Shekhar Malhotra">Shekhar Malhotra</option>
                <option value="Sudha Anil">Sudha Anil</option>
                <option value="Sudhir">Sudhir</option>
                <option value="Supersourcing Technologies Private Limited">
                  Supersourcing Technologies Private Limited
                </option>
                <option value="Test">Test</option>
                <option value="Varun Gupta">Varun Gupta</option>
                <option value="Vinod Kumar Subbaiah">
                  Vinod Kumar Subbaiah
                </option>
                <option value="Vivek Gupta">Vivek Gupta</option>
                <option value="Warren">Warren</option>
                <option value="Webomaze Pty Ltd">Webomaze Pty Ltd</option>
                <option value="Weon Jung">Weon Jung</option>
                <option value="Yoga">Yoga</option>
              </select>
            </div>
            <div class="d-flex" style="gap: 5px">
              <div class="col-md-6">
                <label for="company" class="form-label highlight-label"
                  >Company</label
                >
                <select id="company" name="company" class="form-select custom-height">
                  <option value="">Select--</option>
                  <option value="Gee Sons Knit Fab">Gee Sons Knit Fab</option>
                  <option value="Naxtre">Naxtre</option>
                  <option value="Naxtre Technologies Private Limited">
                    Naxtre Technologies Private Limited
                  </option>
                </select>
              </div>

              <div class="col-md-6">
                <label for="bank" class="form-label highlight-label"
                  >Select Bank A/c</label
                >
                <select id="bank" name="bank" class="form-select custom-height">
                  <option value="select">Select--</option>
                  <option>HDFC BANK LTD</option>
                </select>
              </div>
            </div>

            <div class="col-md-6">
              <label for="issue-date" class="form-label highlight-label"
                >Issue Date</label
              >
              <input
                type="date"
                class="form-control custom-height"
                id="issue-date"
                name="issue-date"
              />
            </div>
            <div class="col-md-6">
              <label for="due-date" class="form-label highlight-label"
                >Due Date</label
              >
              <input
                type="date"
                class="form-control custom-height"
                id="due-date"
                name="due-date"
              />
            </div>
            <div class="col-md-6">
              <label for="invoice-no" class="form-label highlight-label"
                >Invoice No</label
              >
              <input
                placeholder="invoice no"
                type="text"
                class="form-control custom-height"
                id="invoice-no"
                name="invoice-no"
              />
            </div>
            <div class="col-12">
              <div class="table-responsive">
                <table class="table mt-3">
                  <thead class="table-light">
                    <tr>
                      <th class="highlight-label">Title</th>
                      <th class="highlight-label">Description</th>
                      <th class="highlight-label">Quantity</th>
                      <th class="highlight-label">Unit Price</th>
                      <th class="highlight-label">Total Price</th>
                      <th class="highlight-label">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="itemsTableBody">
                    <tr>
                      <td>
                        <input
                          type="text"
                          class="form-control custom-height"
                          name="items[0][title]"
                          placeholder="Enter title"
                        />
                      </td>
                      <td>
                        <input
                          type="text"
                          class="form-control custom-height"
                          name="items[0][description]"
                          placeholder="Enter description"
                        />
                      </td>
                      <td>
                        <input
                          type="number"
                          class="form-control custom-height"
                          name="items[0][quantity]"
                          id="quantity-0"
                          oninput="updateTotalPrice(this)"
                          placeholder="1"
                        />
                      </td>
                      <td>
                        <input
                          type="number"
                          class="form-control custom-height"
                          name="items[0][unit_price]"
                          id="unit-price-0"
                          oninput="updateTotalPrice(this)"
                          placeholder="0.00"
                        />
                      </td>
                      <td>
                        <input
                          type="text"
                          class="form-control custom-height"
                          name="items[0][total_price]"
                          id="total-price-0"
                          readonly
                          placeholder="Total price"
                        />
                      </td>
                      <td class="text-center">
                        <button
                          type="button"
                          class="btn btn-success btn-sm "
                          style="width: 40px; height: 46px;font-weight:700;"
                          onclick="addItem()"
                        >
                          +
                        </button>
                        <button
                          type="button"
                          class="btn btn-danger btn-sm"
                          onclick="removeItem(this)"
                          style="width: 40px; height: 46px;font-weight:700;"

                        >
                          -
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="col-12 d-flex justify-content-between mt-4">
              <button
                type="submit"
                class="btn btn-primary"
                onclick="downloadInvoice()"
              >
                Download
              </button>
              <button
                type="button"
                class="btn btn-secondary"
                onclick="previewInvoice()"
              >
                Preview
              </button>
              <button
                type="button"
                class="btn btn-info"
                onclick="previewWithoutHeader()"
              >
                Preview without Header
              </button>
            </div>
          </div>
        </form>
        <!-- <iframe
        id="pdfPreview"
        style="width: 100%; height: 800px ; border: none"
      ></iframe> -->
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      if (!localStorage.getItem("isAuthenticated")) {
        // If not authenticated, redirect to login page
        window.location.href = "login.html";
      }
      let itemIndex = 1;

      function addItem() {
        const tableBody = document.getElementById("itemsTableBody");
        const newRow = `
         <tr>
      <td><input type="text" class="form-control custom-height" name="items[${itemIndex}][title]" placeholder="Enter title" /></td>
      <td><input type="text" class="form-control custom-height" name="items[${itemIndex}][description]" placeholder="Enter description" /></td>
      <td><input type="number" class="form-control custom-height" name="items[${itemIndex}][quantity]" placeholder="1" id="quantity-${itemIndex}" oninput="updateTotalPrice(this)" /></td>
      <td><input type="number" class="form-control custom-height" name="items[${itemIndex}][unit_price]" id="unit-price-${itemIndex}" placeholder="0.00" oninput="updateTotalPrice(this)" /></td>
      <td><input type="text" class="form-control custom-height" name="items[${itemIndex}][total_price]" placeholder="Total price" id="total-price-${itemIndex}" readonly /></td>
      <td class="text-center">
        <button type="button" class="btn btn-success btn-sm" style="width: 40px; height: 46px;font-weight:700;" onclick="addItem()">+</button>
        <button type="button" class="btn btn-danger btn-sm" style="width: 40px; height: 46px;font-weight:700;"  onclick="removeItem(this)">-</button>
      </td>
    </tr>
        `;
        tableBody.insertAdjacentHTML("beforeend", newRow);
        itemIndex++;
      }
      function updateTotalPrice(input) {
        // Get the row that contains the changed input
        const row = input.closest("tr");
        const quantityInput = row.querySelector(
          'input[name^="items"][name$="[quantity]"]'
        );
        const unitPriceInput = row.querySelector(
          'input[name^="items"][name$="[unit_price]"]'
        );
        const totalPriceInput = row.querySelector(
          'input[name^="items"][name$="[total_price]"]'
        );

        // Get the values
        const quantity = parseFloat(quantityInput.value) || 0;
        const unitPrice = parseFloat(unitPriceInput.value) || 0;

        // Calculate total price
        const totalPrice = quantity * unitPrice;

        // Set the total price input value
        totalPriceInput.value = totalPrice.toFixed(2);
      }

      function removeItem(button) {
        const row = button.parentElement.parentElement;
        row.remove();
      }
      async function downloadInvoice() {
        const form = document.getElementById("invoice-form");
        const formData = new FormData(form);

        // Convert FormData to an object
        const formObject = {};
        formData.forEach((value, key) => {
          if (!key.includes("items")) {
            formObject[key] = value;
          }
        });

        // Collect the items dynamically from the form
        const items = [];
        const rows = document.querySelectorAll("#itemsTableBody tr");
        rows.forEach((row, index) => {
          const item = {
            title: formData.get(`items[${index}][title]`),
            description: formData.get(`items[${index}][description]`),
            quantity: formData.get(`items[${index}][quantity]`),
            unit_price: formData.get(`items[${index}][unit_price]`),
            total_price: formData.get(`items[${index}][total_price]`),
          };
          items.push(item);
        });

        // Add items to the formObject
        formObject.items = items;

        try {
          // Send the data to the server to generate the PDF
          const generateInvoiceResponse = await fetch(
            "http://3.6.200.239:5550/generate-invoice",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(formObject),
            }
          );

          if (!generateInvoiceResponse.ok) {
            throw new Error("Failed to generate invoice");
          }

          const generateInvoiceData = await generateInvoiceResponse.json();
          const pdfUrl = generateInvoiceData.url; // Use the Cloudinary URL
          const response = await fetch(pdfUrl);
          const blob = await response.blob();

          // Generate a filename based on the current date and time
          const timestamp = Date.now();
          const filename = `invoice_${timestamp}.pdf`;

          // Create a URL for the Blob
          const url = URL.createObjectURL(blob);

          // Create a temporary anchor element
          const a = document.createElement("a");
          a.href = url;
          a.download = filename; // Use the generated filename
          a.style.display = "none"; // Hide the anchor element

          // Append anchor to the body
          document.body.appendChild(a);

          // Trigger a click event on the anchor to start the download
          a.click();

          // Clean up
          URL.revokeObjectURL(url); // Release the Blob URL
          document.body.removeChild(a);
        } catch (error) {
          console.error("Error generating or downloading invoice:", error);
        }
      }
    </script>
    <script>
      function incrementQuantity(button) {
        const inputField = button.previousElementSibling;
        inputField.value = parseInt(inputField.value) + 1;
      }

      function decrementQuantity(button) {
        const inputField = button.nextElementSibling;
        if (parseInt(inputField.value) > 1) {
          inputField.value = parseInt(inputField.value) - 1;
        }
      }

      document
        .getElementById("invoice-form")
        .addEventListener("submit", function (event) {
          event.preventDefault(); // Prevent the default form submission

          // Create a FormData object from the form
          const formData = new FormData(this);

          // Convert FormData to a plain object, except for the items
          const formObject = {};
          formData.forEach((value, key) => {
            if (!key.includes("items")) {
              formObject[key] = value;
            }
          });

          // Collect items dynamically from the table rows
          const items = [];
          document
            .querySelectorAll("#itemsTableBody tr")
            .forEach((row, index) => {
              const item = {
                title: row.querySelector(`[name="items[${index}][title]"]`)
                  .value,
                description: row.querySelector(
                  `[name="items[${index}][description]"]`
                ).value,
                quantity: row.querySelector(
                  `[name="items[${index}][quantity]"]`
                ).value,
                unit_price: row.querySelector(
                  `[name="items[${index}][unit_price]"]`
                ).value,
                total_price: row.querySelector(
                  `[name="items[${index}][total_price]"]`
                ).value,
              };
              items.push(item);
            });

          // Add items array to the form object
          formObject.items = items;

          // Send data to the server using fetch
          fetch("http://3.6.200.239:5550/submit-form", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(formObject),
          })
            .then((response) => response.json())
            .then((data) => {
              console.log("Success:", data);
              // Handle success, e.g., show a success message
            })
            .catch((error) => {
              console.error("Error:", error);
              // Handle error, e.g., show an error message
            });
        });
    </script>
    <script>
      async function previewInvoice() {
        const form = document.getElementById("invoice-form");
        const formData = new FormData(form);

        // Convert FormData to an object
        const formObject = {};
        formData.forEach((value, key) => {
          if (!key.includes("items")) {
            formObject[key] = value;
          }
        });

        // Collect the items dynamically from the form
        const items = [];
        const rows = document.querySelectorAll("#itemsTableBody tr");
        rows.forEach((row, index) => {
          const item = {
            title: formData.get(`items[${index}][title]`),
            description: formData.get(`items[${index}][description]`),
            quantity: formData.get(`items[${index}][quantity]`),
            unit_price: formData.get(`items[${index}][unit_price]`),
            total_price: formData.get(`items[${index}][total_price]`),
          };
          items.push(item);
        });

        formObject.items = items;

        try {
          // Send the data to the server to generate the PDF
          const generateInvoiceResponse = await fetch(
            "http://3.6.200.239:5550/generate-invoice",

            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(formObject),
            }
          );
          console.log("res", generateInvoiceResponse);

          if (!generateInvoiceResponse.ok) {
            throw new Error("Failed to generate invoice");
          }

          const generateInvoiceData = await generateInvoiceResponse.json();
          const pdfUrl = generateInvoiceData.url; // Use the Cloudinary URL

          // Open the PDF in a new tab
          const newTab = window.open();
          newTab.location.href = pdfUrl;
        } catch (error) {
          console.error("Error generating or previewing invoice:", error);
        }
      }
    </script>

    <script>
      async function previewWithoutHeader() {
        const form = document.getElementById("invoice-form");
        const formData = new FormData(form);

        // Convert FormData to an object
        const formObject = {};
        formData.forEach((value, key) => {
          if (!key.includes("items")) {
            formObject[key] = value;
          }
        });

        // Collect the items dynamically from the form
        const items = [];
        const rows = document.querySelectorAll("#itemsTableBody tr");
        rows.forEach((row, index) => {
          const item = {
            title: formData.get(`items[${index}][title]`),
            description: formData.get(`items[${index}][description]`),
            quantity: formData.get(`items[${index}][quantity]`),
            unit_price: formData.get(`items[${index}][unit_price]`),
            total_price: formData.get(`items[${index}][total_price]`),
          };
          items.push(item);
        });

        formObject.items = items;

        try {
          // Send the data to the server to generate the PDF
          const generateInvoiceResponse = await fetch(
            "http://3.6.200.239:5550/generate-wh-invoice",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(formObject),
            }
          );

          if (!generateInvoiceResponse.ok) {
            throw new Error("Failed to generate invoice");
          }

          const generateInvoiceData = await generateInvoiceResponse.json();
          const pdfUrl = generateInvoiceData.url; // Use the Cloudinary URL

          // Open the PDF in a new tab
          const newTab = window.open();
          newTab.location.href = pdfUrl;
        } catch (error) {
          console.error("Error generating or previewing invoice:", error);
        }
      }
    </script>
  </body>
</html>
